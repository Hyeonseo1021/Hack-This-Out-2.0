import React, { useEffect, useState, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { toast } from 'react-toastify';
import socket from '../../utils/socket';
import '../../assets/scss/arena/VulnerabilityScannerRace.scss';

interface Vulnerability {
  vulnId: string;
  name: string;
  type: string;
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  points: number;
  discoveredBy?: string;
  discoveredByUsername?: string;
  isFirstBlood?: boolean;
}

interface Player {
  userId: string;
  username: string;
  score: number;
  vulnerabilitiesFound: number;
}

interface GameState {
  targetUrl: string;
  targetName: string | { ko: string; en: string };
  targetDescription: string | { ko: string; en: string };
  mode: 'SIMULATED' | 'REAL';
  vulnerableHTML: string;
  vulnerabilities: Vulnerability[];
  leaderboard: Player[];
  myProgress: {
    score: number;
    foundVulnerabilities: string[];
    rank: number;
  };
}

interface VulnerabilityScannerRaceProps {
  arenaId: string;
  userId: string;
}

const VulnerabilityScannerRace: React.FC<VulnerabilityScannerRaceProps> = ({
  arenaId,
  userId
}) => {
  const navigate = useNavigate();
  const { t, i18n } = useTranslation('arena');
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const iframeLoadedRef = useRef(false); // iframe ì´ˆê¸° ë¡œë“œ ì™„ë£Œ ì—¬ë¶€

  const [loading, setLoading] = useState(true);
  const [gameState, setGameState] = useState<GameState | null>(null);

  // ì œì¶œ í¼ ìƒíƒœ
  const [vulnType, setVulnType] = useState('');
  const [endpoint, setEndpoint] = useState('');
  const [parameter, setParameter] = useState('');
  const [payload, setPayload] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const alertShownRef = useRef(false); // ì•Œë¦¼ ì¤‘ë³µ ë°©ì§€

  // ìœ ì˜ˆ ì‹œê°„ ìƒíƒœ
  const [gracePeriodActive, setGracePeriodActive] = useState(false);
  const [gracePeriodRemaining, setGracePeriodRemaining] = useState(0);
  const gracePeriodIntervalRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    console.log('ğŸ”„ [VulnerabilityScannerRace] useEffect running, arenaId:', arenaId);

    // ê²Œì„ ìƒíƒœ ìš”ì²­
    socket.emit('scannerRace:get-state');

    // ê²Œì„ ìƒíƒœ ìˆ˜ì‹ 
    const handleStateData = (data: GameState) => {
      console.log('ğŸ“¥ [handleStateData] Received game state:', data);
      console.log('ğŸ“¥ [handleStateData] targetName:', data.targetName);
      console.log('ğŸ“¥ [handleStateData] targetDescription:', data.targetDescription);
      console.log('ğŸ“¥ [handleStateData] vulnerableHTML length:', data.vulnerableHTML?.length || 0);
      console.log('ğŸ“¥ [handleStateData] vulnerabilities count:', data.vulnerabilities?.length || 0);
      setGameState(data);
      setLoading(false);
    };

    // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
    const handleLeaderboardUpdate = (data: { scores: Player[] }) => {
      console.log('ğŸ“Š [handleLeaderboardUpdate] Received score update:', data);
      setGameState(prev => prev ? { ...prev, leaderboard: data.scores } : null);
    };

    // ì œì¶œ ì„±ê³µ
    const handleSubmissionSuccess = (data: any) => {
      console.log('âœ… [handleSubmissionSuccess] Submission success:', data);

      // ì´ë¯¸ ì•Œë¦¼ í‘œì‹œ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (alertShownRef.current) {
        console.warn('âš ï¸ Alert already shown, ignoring duplicate success event');
        return;
      }

      alertShownRef.current = true;
      setSubmitting(false);

      // í¼ ì´ˆê¸°í™”
      setVulnType('');
      setEndpoint('');
      setParameter('');
      setPayload('');

      // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
      socket.emit('scannerRace:get-state');

      // âœ… Toast ì•Œë¦¼ìœ¼ë¡œ ë³€ê²½
      toast.success(t('toast.vulnerabilityFound', { message: data.message || t('toast.vulnerabilityFound'), points: data.pointsAwarded || 0 }), {
        position: 'top-right',
        autoClose: 3000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
      });

      // ì•Œë¦¼ í‘œì‹œ í›„ í”Œë˜ê·¸ ë¦¬ì…‹
      setTimeout(() => {
        alertShownRef.current = false;
      }, 500);
    };

    // ì œì¶œ ì‹¤íŒ¨
    const handleSubmissionFailed = (data: any) => {
      console.log('âŒ [handleSubmissionFailed] Submission failed:', data);

      // ì´ë¯¸ ì•Œë¦¼ í‘œì‹œ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (alertShownRef.current) {
        console.warn('âš ï¸ Alert already shown, ignoring duplicate failed event');
        return;
      }

      alertShownRef.current = true;
      setSubmitting(false);

      // ìƒíƒœ ìƒˆë¡œê³ ì¹¨ (ì ìˆ˜ ë°˜ì˜)
      socket.emit('scannerRace:get-state');

      // âœ… í˜ë„í‹° ì ìˆ˜ í‘œì‹œ
      const penalty = data.pointsAwarded ? Math.abs(data.pointsAwarded) : 0;
      const message = penalty > 0
        ? `${data.message || t('toast.incorrectReport')} (-${penalty}pts)`
        : data.message || t('toast.incorrectReport');

      toast.error(message, {
        position: 'top-right',
        autoClose: 3000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
      });

      // ì•Œë¦¼ í‘œì‹œ í›„ í”Œë˜ê·¸ ë¦¬ì…‹
      setTimeout(() => {
        alertShownRef.current = false;
      }, 500);
    };

    // ìœ ì˜ˆ ì‹œê°„ ì‹œì‘ í•¸ë“¤ëŸ¬
    const handleGracePeriodStarted = (data: { graceMs: number; graceSec: number; message: string }) => {
      console.log('â³ [handleGracePeriodStarted] Grace period started:', data);

      setGracePeriodActive(true);
      setGracePeriodRemaining(data.graceSec);

      // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì •ë¦¬
      if (gracePeriodIntervalRef.current) {
        clearInterval(gracePeriodIntervalRef.current);
      }

      // 1ì´ˆë§ˆë‹¤ ì¹´ìš´íŠ¸ë‹¤ìš´
      gracePeriodIntervalRef.current = setInterval(() => {
        setGracePeriodRemaining(prev => {
          if (prev <= 1) {
            if (gracePeriodIntervalRef.current) {
              clearInterval(gracePeriodIntervalRef.current);
              gracePeriodIntervalRef.current = null;
            }
            setGracePeriodActive(false);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    };

    socket.on('scannerRace:state-data', handleStateData);
    socket.on('scannerRace:scores-update', handleLeaderboardUpdate);
    socket.on('scannerRace:submission-success', handleSubmissionSuccess);
    socket.on('scannerRace:submission-failed', handleSubmissionFailed);
    socket.on('arena:grace-period-started', handleGracePeriodStarted);

    console.log('âœ… [VulnerabilityScannerRace] Event listeners registered');

    return () => {
      console.log('ğŸ§¹ [VulnerabilityScannerRace] Cleaning up event listeners');

      // ìœ ì˜ˆ ì‹œê°„ íƒ€ì´ë¨¸ ì •ë¦¬
      if (gracePeriodIntervalRef.current) {
        clearInterval(gracePeriodIntervalRef.current);
        gracePeriodIntervalRef.current = null;
      }

      socket.off('scannerRace:state-data', handleStateData);
      socket.off('scannerRace:scores-update', handleLeaderboardUpdate);
      socket.off('scannerRace:submission-success', handleSubmissionSuccess);
      socket.off('scannerRace:submission-failed', handleSubmissionFailed);
      socket.off('arena:grace-period-started', handleGracePeriodStarted);
    };
  }, [arenaId, navigate]);

  // iframe navigation ë°©ì§€
  useEffect(() => {
    const iframe = iframeRef.current;
    if (!iframe || !gameState?.vulnerableHTML) return;

    const handleIframeLoad = () => {
      if (!iframeLoadedRef.current) {
        // ì²« ë¡œë“œ
        console.log('âœ… [iframe] Initial load complete');
        iframeLoadedRef.current = true;
      } else {
        // ì´í›„ ë¡œë“œ = navigation ë°œìƒ â†’ ì›ë˜ HTMLë¡œ ë³µì›
        console.warn('âš ï¸ [iframe] Navigation detected, restoring original HTML');
        if (iframe.contentDocument) {
          iframe.contentDocument.open();
          iframe.contentDocument.write(gameState.vulnerableHTML);
          iframe.contentDocument.close();
        }
      }
    };

    iframe.addEventListener('load', handleIframeLoad);

    return () => {
      iframe.removeEventListener('load', handleIframeLoad);
      iframeLoadedRef.current = false; // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ë¦¬ì…‹
    };
  }, [gameState?.vulnerableHTML]);

  // postMessage í•¸ë“¤ëŸ¬ (ìë™ ì·¨ì•½ì  ê°ì§€)
  useEffect(() => {
    const handleIframeMessage = (event: MessageEvent) => {
      // ë””ë²„ê¹…: ëª¨ë“  postMessage ë¡œê·¸
      console.log('ğŸ“¨ [postMessage] Received message:', event.data);

      if (event.data.type === 'vulnerability_found') {
        const { vulnId, vulnType, endpoint, parameter, payload } = event.data;
        console.log('ğŸ¯ [postMessage] Auto-detected vulnerability:', vulnType, endpoint, parameter, payload);

        // ì¤‘ë³µ ì œì¶œ ë°©ì§€
        if (submitting) {
          console.warn('âš ï¸ [postMessage] Already submitting, ignoring auto-detection');
          return;
        }

        // ìë™ ì œì¶œ
        setSubmitting(true);
        socket.emit('scannerRace:submit', {
          vulnType: vulnType,
          endpoint: endpoint || '/',
          parameter: parameter || '',
          payload: payload || ''
        });
        console.log('ğŸ“¤ [postMessage] Auto-submitted vulnerability');
      }
    };

    window.addEventListener('message', handleIframeMessage);

    return () => {
      window.removeEventListener('message', handleIframeMessage);
    };
  }, [submitting]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (submitting) return;

    console.log('ğŸ“¤ [handleSubmit] Submitting vulnerability:', {
      vulnType, endpoint, parameter, payload
    });

    setSubmitting(true);

    socket.emit('scannerRace:submit', {
      vulnType,
      endpoint,
      parameter,
      payload
    });
  };

  if (loading || !gameState) {
    return (
      <div className="scanner-race-container loading">
        <div className="loading-spinner">Loading Scanner Race...</div>
      </div>
    );
  }

  const myProgress = gameState.myProgress;
  const isSimulated = gameState.mode === 'SIMULATED';

  return (
    <div className="scanner-race-container">
      {/* í—¤ë” */}
      <div className="scanner-header">
        <div className="header-info">
          <h2 className="mode-title">Vulnerability Scanner Race</h2>
          <p className="target-name">
            {typeof gameState.targetName === 'object'
              ? (gameState.targetName[i18n.language as 'ko' | 'en'] || gameState.targetName.ko || gameState.targetName.en)
              : gameState.targetName}
          </p>
        </div>
        <div className="header-stats">
          <div className="stat-box">
            <span className="stat-label">SCORE</span>
            <span className="stat-value">{myProgress.score}</span>
          </div>
          <div className="stat-box">
            <span className="stat-label">VULNS</span>
            <span className="stat-value">{myProgress.foundVulnerabilities.length}/{gameState.vulnerabilities?.length || 0}</span>
          </div>
          <div className="stat-box rank">
            <span className="stat-label">RANK</span>
            <span className="stat-value">#{myProgress.rank}</span>
          </div>
        </div>
      </div>

      {/* ë©”ì¸ ì½˜í…ì¸  */}
      <div className="scanner-main">
        {/* ì™¼ìª½: íƒ€ê²Ÿ ì• í”Œë¦¬ì¼€ì´ì…˜ */}
        <div className="target-container">
          <div className="target-header">
            <div className="header-title">
              <span className="icon">â–¸</span>
              <h3>TARGET APPLICATION</h3>
              <span className="vulns-remaining">
                {myProgress.foundVulnerabilities.length}/{gameState.vulnerabilities?.length || 0} found
              </span>
            </div>
            <p className="target-desc">
              {typeof gameState.targetDescription === 'object'
                ? (gameState.targetDescription[i18n.language as 'ko' | 'en'] || gameState.targetDescription.ko || gameState.targetDescription.en)
                : gameState.targetDescription}
            </p>
          </div>

          {isSimulated ? (
            <iframe
              ref={iframeRef}
              srcDoc={gameState.vulnerableHTML}
              sandbox="allow-scripts allow-forms allow-modals"
              className="target-iframe"
              title={t('game.vulnerableApp')}
            />
          ) : (
            <div className="target-link">
              <div className="link-box">
                <div className="url-display">
                  <span className="label">TARGET URL:</span>
                  <code className="url">{gameState.targetUrl}</code>
                </div>
                <a
                  href={gameState.targetUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="launch-btn"
                >
                  OPEN TARGET â†’
                </a>
              </div>
            </div>
          )}
        </div>

        {/* ì˜¤ë¥¸ìª½: ì •ë³´ íŒ¨ë„ */}
        <div className="info-panel">
          {/* ì·¨ì•½ì  ì²´í¬ë¦¬ìŠ¤íŠ¸ */}
          <div className="vulnerabilities-section">
            <div className="section-header">
              <span className="icon">â—‰</span>
              <h3>TARGETS</h3>
              <span className="count">{myProgress.foundVulnerabilities.length}/{gameState.vulnerabilities?.length || 0}</span>
            </div>
            <div className="vuln-list">
              {(gameState.vulnerabilities || []).map((vuln) => {
                // âœ… ë‚´ê°€ ë°œê²¬í•œ ì·¨ì•½ì ì¸ì§€ í™•ì¸ (foundVulnerabilities ë°°ì—´ì— ìˆëŠ”ì§€)
                const isFoundByMe = myProgress.foundVulnerabilities.includes(vuln.vulnId);
                // âœ… ëˆ„êµ°ê°€ê°€ ë°œê²¬í–ˆëŠ”ì§€ í™•ì¸ (discoveredBy í•„ë“œ ì¡´ì¬ ì—¬ë¶€)
                const isDiscoveredBySomeone = !!vuln.discoveredBy;

                return (
                  <div
                    key={vuln.vulnId}
                    className={`vuln-item ${isFoundByMe ? 'found mine' : ''} ${isDiscoveredBySomeone && !isFoundByMe ? 'found-by-other' : ''}`}
                  >
                    <div className="vuln-status">
                      <span className={`status-indicator ${isFoundByMe ? 'found' : ''}`}>
                        {isFoundByMe ? 'â—' : 'â—‹'}
                      </span>
                    </div>
                    <div className="vuln-info">
                      <div className="vuln-name">{vuln.name}</div>
                      <div className="vuln-meta">
                        <span className={`severity severity-${vuln.severity.toLowerCase()}`}>
                          {vuln.severity}
                        </span>
                        <span className="type">{vuln.type}</span>
                        <span className="points">+{vuln.points}</span>
                      </div>
                      {/* âœ… First Blood í‘œì‹œ ì œê±° */}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* ì œì¶œ í¼ */}
          <div className="submit-section">
            <div className="section-header">
              <span className="icon">â–¸</span>
              <h3>REPORT FINDING</h3>
            </div>
            <form onSubmit={handleSubmit} className="submit-form">
              <div className="form-row">
                <div className="form-group">
                  <label>VULNERABILITY TYPE</label>
                  <select
                    value={vulnType}
                    onChange={e => setVulnType(e.target.value)}
                    required
                  >
                    <option value="">-- SELECT --</option>
                    <option value="SQLi">SQL Injection</option>
                    <option value="XSS">XSS</option>
                    <option value="CSRF">CSRF</option>
                    <option value="IDOR">IDOR</option>
                    <option value="Path Traversal">Path Traversal</option>
                    <option value="Command Injection">Command Injection</option>
                    <option value="Broken Authentication">Auth Bypass</option>
                    <option value="Security Misconfiguration">Misconfiguration</option>
                  </select>
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>ENDPOINT</label>
                  <input
                    type="text"
                    value={endpoint}
                    onChange={e => setEndpoint(e.target.value)}
                    placeholder="/api/login"
                    required
                  />
                </div>
              </div>

              <div className="form-row-split">
                <div className="form-group">
                  <label>PARAMETER</label>
                  <input
                    type="text"
                    value={parameter}
                    onChange={e => setParameter(e.target.value)}
                    placeholder="username"
                  />
                </div>
                <div className="form-group">
                  <label>PAYLOAD</label>
                  <input
                    type="text"
                    value={payload}
                    onChange={e => setPayload(e.target.value)}
                    placeholder="' OR 1=1--"
                  />
                </div>
              </div>

              <button type="submit" className="submit-btn" disabled={submitting}>
                {submitting ? 'PROCESSING...' : 'SUBMIT REPORT'}
              </button>
            </form>
          </div>

          {/* âœ… Grace Period Section - ê°„ê²°í•˜ê²Œ ìˆ˜ì • */}
          {gracePeriodActive && (
            <div className="grace-period-section compact">
              <div className="grace-content">
                <div className="grace-icon">â³</div>
                <div className="grace-info">
                  <div className="grace-title">GRACE PERIOD</div>
                  <div className="grace-text">
                    Time remaining: <strong>{gracePeriodRemaining}s</strong>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityScannerRace;