// src/components/arena/VulnerabilityScannerRace.tsx
import React, { useEffect, useState, useRef } from 'react';
import socket from '../../utils/socket';
import '../../assets/scss/arena/VulnerabilityScannerRace.scss';

interface Props {
  arenaId: string;
  userId: string;
}

interface Vulnerability {
  vulnId: string;
  vulnType: string;
  difficulty: string;
  basePoints: number;
  category: string;
  discovered: boolean;
  discoveredByMe: boolean;
  isFirstBlood: boolean;
  pointsEarned: number;
}

interface Score {
  rank: number;
  userId: string;
  username: string;
  score: number;
  vulnerabilitiesFound: number;
  firstBloods: number;
  invalidSubmissions: number;
}

interface GameState {
  myScore: number;
  myVulnerabilitiesFound: number;
  myFirstBloods: number;
  myInvalidSubmissions: number;
  totalVulnerabilities: number;
  targetUrl: string;
  targetName: string;
  features: string[];
}

interface Activity {
  id: string;
  type: 'found' | 'failed' | 'hint';
  message: string;
  timestamp: number;
}

const VulnerabilityScannerRace: React.FC<Props> = ({ arenaId, userId }) => {
  const [gameState, setGameState] = useState<GameState | null>(null);
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [scores, setScores] = useState<Score[]>([]);
  const [activities, setActivities] = useState<Activity[]>([]);
  
  // ì œì¶œ í¼
  const [vulnType, setVulnType] = useState('SQLi');
  const [endpoint, setEndpoint] = useState('');
  const [parameter, setParameter] = useState('');
  const [payload, setPayload] = useState('');
  const [submitting, setSubmitting] = useState(false);
  
  // íŒíŠ¸
  const [selectedVulnForHint, setSelectedVulnForHint] = useState<string | null>(null);
  const [hintLevel, setHintLevel] = useState(1);

  const activitiesEndRef = useRef<HTMLDivElement>(null);

  // ì·¨ì•½ì  íƒ€ì… ëª©ë¡
  const vulnTypes = [
    'SQLi',
    'XSS',
    'IDOR',
    'PATH_TRAVERSAL',
    'CSRF',
    'COMMAND_INJECTION',
    'FILE_UPLOAD',
    'AUTH_BYPASS',
    'INFO_DISCLOSURE',
    'XXE',
    'SSRF',
    'DESERIALIZATION'
  ];

  useEffect(() => {
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    socket.emit('scannerRace:get-state');
    socket.emit('scannerRace:get-vulnerabilities');
    socket.emit('scannerRace:get-scores');

    // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    socket.on('scannerRace:state-data', handleStateData);
    socket.on('scannerRace:vulnerabilities-data', handleVulnerabilitiesData);
    socket.on('scannerRace:scores-data', handleScoresData);
    socket.on('scannerRace:submission-success', handleSubmissionSuccess);
    socket.on('scannerRace:submission-failed', handleSubmissionFailed);
    socket.on('scannerRace:vulnerability-found', handleVulnerabilityFound);
    socket.on('scannerRace:scores-update', handleScoresUpdate);
    socket.on('scannerRace:hint-received', handleHintReceived);
    socket.on('scannerRace:score-update', handleScoreUpdate);
    socket.on('scannerRace:error', handleError);

    return () => {
      socket.off('scannerRace:state-data', handleStateData);
      socket.off('scannerRace:vulnerabilities-data', handleVulnerabilitiesData);
      socket.off('scannerRace:scores-data', handleScoresData);
      socket.off('scannerRace:submission-success', handleSubmissionSuccess);
      socket.off('scannerRace:submission-failed', handleSubmissionFailed);
      socket.off('scannerRace:vulnerability-found', handleVulnerabilityFound);
      socket.off('scannerRace:scores-update', handleScoresUpdate);
      socket.off('scannerRace:hint-received', handleHintReceived);
      socket.off('scannerRace:score-update', handleScoreUpdate);
      socket.off('scannerRace:error', handleError);
    };
  }, []);

  useEffect(() => {
    // í™œë™ ë¡œê·¸ ìë™ ìŠ¤í¬ë¡¤
    activitiesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [activities]);

  const handleStateData = (data: GameState) => {
    setGameState(data);
  };

  const handleVulnerabilitiesData = (data: any) => {
    setVulnerabilities(data.vulnerabilities);
  };

  const handleScoresData = (data: any) => {
    setScores(data.scores);
  };

  const handleSubmissionSuccess = (data: any) => {
    setSubmitting(false);
    
    // í¼ ì´ˆê¸°í™”
    setEndpoint('');
    setParameter('');
    setPayload('');

    // í™œë™ ì¶”ê°€
    addActivity('found', `âœ… ${data.message} (+${data.pointsAwarded}pts)${data.isFirstBlood ? ' ğŸ”¥ First Blood!' : ''}`);

    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    socket.emit('scannerRace:get-vulnerabilities');
    socket.emit('scannerRace:get-state');
  };

  const handleSubmissionFailed = (data: any) => {
    setSubmitting(false);
    addActivity('failed', `âŒ ${data.message}${data.pointsAwarded < 0 ? ` (${data.pointsAwarded}pts)` : ''}`);
  };

  const handleVulnerabilityFound = (data: any) => {
    if (data.userId !== userId) {
      // ìƒëŒ€ë°©ì´ ë°œê²¬
      addActivity('found', `ğŸ“¢ ${data.vulnName || data.vulnType} discovered by opponent!`);
    }
  };

  const handleScoresUpdate = (data: any) => {
    setScores(data.scores);
  };

  const handleHintReceived = (data: any) => {
    addActivity('hint', `ğŸ’¡ Hint: ${data.hint} (-${data.cost}pts)`);
    setSelectedVulnForHint(null);
  };

  const handleScoreUpdate = (data: any) => {
    if (gameState) {
      setGameState({
        ...gameState,
        myScore: data.score
      });
    }
  };

  const handleError = (data: any) => {
    addActivity('failed', `âš ï¸ Error: ${data.message}`);
  };

  const addActivity = (type: Activity['type'], message: string) => {
    const newActivity: Activity = {
      id: Date.now().toString(),
      type,
      message,
      timestamp: Date.now()
    };
    setActivities(prev => [...prev, newActivity].slice(-20)); // ìµœê·¼ 20ê°œë§Œ ìœ ì§€
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!endpoint || !payload) {
      addActivity('failed', 'âš ï¸ Please fill in all required fields');
      return;
    }

    setSubmitting(true);

    socket.emit('scannerRace:submit', {
      vulnType,
      endpoint,
      parameter,
      payload
    });
  };

  const handleRequestHint = (vulnId: string, level: number) => {
    socket.emit('scannerRace:request-hint', {
      vulnId,
      hintLevel: level
    });
  };

  // ë‚´ ì ìˆ˜
  const myScore = scores.find(s => s.userId === userId);

  if (!gameState) {
    return (
      <div className="scanner-race-loading">
        <div className="spinner"></div>
        <p>Loading game...</p>
      </div>
    );
  }

  return (
    <div className="vulnerability-scanner-race">
      {/* í—¤ë” */}
      <div className="scanner-header">
        <div className="target-info">
          <h2>ğŸ” {gameState.targetName}</h2>
          <p className="target-url">{gameState.targetUrl}</p>
        </div>
        <div className="my-stats">
          <div className="stat">
            <span className="stat-label">Score</span>
            <span className="stat-value">{myScore?.score || 0}</span>
          </div>
          <div className="stat">
            <span className="stat-label">Found</span>
            <span className="stat-value">{gameState.myVulnerabilitiesFound}/{gameState.totalVulnerabilities}</span>
          </div>
          <div className="stat">
            <span className="stat-label">ğŸ”¥ First Bloods</span>
            <span className="stat-value">{gameState.myFirstBloods}</span>
          </div>
        </div>
      </div>

      <div className="scanner-content">
        {/* ì™¼ìª½: ì œì¶œ í¼ */}
        <div className="scanner-left">
          <div className="submit-form">
            <h3>Submit Vulnerability</h3>
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label>Vulnerability Type</label>
                <select 
                  value={vulnType} 
                  onChange={(e) => setVulnType(e.target.value)}
                  disabled={submitting}
                >
                  {vulnTypes.map(type => (
                    <option key={type} value={type}>{type}</option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <label>Endpoint *</label>
                <input 
                  type="text"
                  placeholder="/api/endpoint"
                  value={endpoint}
                  onChange={(e) => setEndpoint(e.target.value)}
                  disabled={submitting}
                  required
                />
              </div>

              <div className="form-group">
                <label>Parameter</label>
                <input 
                  type="text"
                  placeholder="paramName (optional)"
                  value={parameter}
                  onChange={(e) => setParameter(e.target.value)}
                  disabled={submitting}
                />
              </div>

              <div className="form-group">
                <label>Payload *</label>
                <textarea 
                  placeholder="Enter your exploit payload..."
                  value={payload}
                  onChange={(e) => setPayload(e.target.value)}
                  disabled={submitting}
                  rows={4}
                  required
                />
              </div>

              <button 
                type="submit" 
                className="submit-btn"
                disabled={submitting}
              >
                {submitting ? 'Submitting...' : 'Submit Vulnerability'}
              </button>
            </form>
          </div>

          {/* í™œë™ ë¡œê·¸ */}
          <div className="activity-feed">
            <h3>Activity Feed</h3>
            <div className="activities">
              {activities.length === 0 ? (
                <p className="no-activity">No activity yet...</p>
              ) : (
                activities.map(activity => (
                  <div key={activity.id} className={`activity activity-${activity.type}`}>
                    <span className="activity-message">{activity.message}</span>
                  </div>
                ))
              )}
              <div ref={activitiesEndRef} />
            </div>
          </div>
        </div>

        {/* ì˜¤ë¥¸ìª½: ì·¨ì•½ì  ëª©ë¡ & ì ìˆ˜íŒ */}
        <div className="scanner-right">
          {/* ì ìˆ˜íŒ */}
          <div className="scoreboard">
            <h3>Scoreboard</h3>
            <div className="scores">
              {scores.map(score => (
                <div 
                  key={score.userId} 
                  className={`score-item ${score.userId === userId ? 'my-score' : ''}`}
                >
                  <div className="score-rank">#{score.rank}</div>
                  <div className="score-info">
                    <div className="score-username">{score.username}</div>
                    <div className="score-details">
                      {score.vulnerabilitiesFound} found
                      {score.firstBloods > 0 && ` â€¢ ${score.firstBloods}ğŸ”¥`}
                    </div>
                  </div>
                  <div className="score-points">{score.score}</div>
                </div>
              ))}
            </div>
          </div>

          {/* ì·¨ì•½ì  ëª©ë¡ */}
          <div className="vulnerabilities-list">
            <h3>Vulnerabilities ({gameState.myVulnerabilitiesFound}/{gameState.totalVulnerabilities})</h3>
            <div className="vulns">
              {vulnerabilities.map(vuln => (
                <div 
                  key={vuln.vulnId} 
                  className={`vuln-item ${vuln.discovered ? 'discovered' : ''} ${vuln.discoveredByMe ? 'my-discovery' : ''}`}
                >
                  <div className="vuln-header">
                    <div className="vuln-type">
                      {vuln.discovered ? (
                        vuln.discoveredByMe ? 'âœ…' : 'ğŸ“¢'
                      ) : 'ğŸ”’'} {vuln.vulnType}
                    </div>
                    <div className="vuln-difficulty">{vuln.difficulty}</div>
                  </div>
                  
                  <div className="vuln-info">
                    <span className="vuln-category">{vuln.category}</span>
                    <span className="vuln-points">{vuln.basePoints}pts</span>
                  </div>

                  {vuln.discoveredByMe && vuln.isFirstBlood && (
                    <div className="first-blood-badge">ğŸ”¥ First Blood!</div>
                  )}

                  {!vuln.discovered && (
                    <div className="vuln-hints">
                      <button 
                        className="hint-btn"
                        onClick={() => {
                          setSelectedVulnForHint(vuln.vulnId);
                          setHintLevel(1);
                        }}
                      >
                        ğŸ’¡ Get Hint
                      </button>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* íŒíŠ¸ ëª¨ë‹¬ */}
      {selectedVulnForHint && (
        <div className="hint-modal-overlay" onClick={() => setSelectedVulnForHint(null)}>
          <div className="hint-modal" onClick={(e) => e.stopPropagation()}>
            <h3>Request Hint</h3>
            <p>Select hint level:</p>
            <div className="hint-levels">
              <button 
                className="hint-level-btn"
                onClick={() => {
                  handleRequestHint(selectedVulnForHint, 1);
                }}
              >
                Level 1 (Location) -10pts
              </button>
              <button 
                className="hint-level-btn"
                onClick={() => {
                  handleRequestHint(selectedVulnForHint, 2);
                }}
              >
                Level 2 (Type) -20pts
              </button>
              <button 
                className="hint-level-btn"
                onClick={() => {
                  handleRequestHint(selectedVulnForHint, 3);
                }}
              >
                Level 3 (Details) -30pts
              </button>
            </div>
            <button 
              className="close-btn"
              onClick={() => setSelectedVulnForHint(null)}
            >
              Cancel
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default VulnerabilityScannerRace;