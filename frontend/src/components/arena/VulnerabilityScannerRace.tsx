import React, { useEffect, useState, useRef } from 'react';
import socket from '../../utils/socket';
import '../../assets/scss/arena/VulnerabilityScannerRace.scss';

interface Vulnerability {
  vulnId: string;
  name: string;
  type: string;
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  points: number;
  discoveredBy?: string;
  discoveredByUsername?: string;
  isFirstBlood?: boolean;
}

interface Player {
  userId: string;
  username: string;
  score: number;
  vulnerabilitiesFound: number;
}

interface GameState {
  targetUrl: string;
  targetName: string;
  targetDescription: string;
  mode: 'SIMULATED' | 'REAL';
  vulnerableHTML: string;
  vulnerabilities: Vulnerability[];
  leaderboard: Player[];
  myProgress: {
    score: number;
    foundVulnerabilities: string[];
    rank: number;
  };
}

interface VulnerabilityScannerRaceProps {
  arenaId: string;
  userId: string;
}

const VulnerabilityScannerRace: React.FC<VulnerabilityScannerRaceProps> = ({
  arenaId,
  userId
}) => {
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const iframeLoadedRef = useRef(false); // iframe Ï¥àÍ∏∞ Î°úÎìú ÏôÑÎ£å Ïó¨Î∂Ä

  const [loading, setLoading] = useState(true);
  const [gameState, setGameState] = useState<GameState | null>(null);

  // Ï†úÏ∂ú Ìèº ÏÉÅÌÉú
  const [vulnType, setVulnType] = useState('');
  const [endpoint, setEndpoint] = useState('');
  const [parameter, setParameter] = useState('');
  const [payload, setPayload] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const alertShownRef = useRef(false); // ÏïåÎ¶º Ï§ëÎ≥µ Î∞©ÏßÄ

  useEffect(() => {
    console.log('üîÑ [VulnerabilityScannerRace] useEffect running, arenaId:', arenaId);

    // Í≤åÏûÑ ÏÉÅÌÉú ÏöîÏ≤≠
    socket.emit('scannerRace:get-state');

    // Í≤åÏûÑ ÏÉÅÌÉú ÏàòÏã†
    const handleStateData = (data: GameState) => {
      console.log('üì• [handleStateData] Received game state:', data);
      setGameState(data);
      setLoading(false);
    };

    // Î¶¨ÎçîÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
    const handleLeaderboardUpdate = (data: { scores: Player[] }) => {
      console.log('üìä [handleLeaderboardUpdate] Received score update:', data);
      setGameState(prev => prev ? { ...prev, leaderboard: data.scores } : null);
    };

    // Ï†úÏ∂ú ÏÑ±Í≥µ
    const handleSubmissionSuccess = (data: any) => {
      console.log('‚úÖ [handleSubmissionSuccess] Submission success:', data);

      // Ïù¥ÎØ∏ ÏïåÎ¶º ÌëúÏãú Ï§ëÏù¥Î©¥ Î¨¥Ïãú
      if (alertShownRef.current) {
        console.warn('‚ö†Ô∏è Alert already shown, ignoring duplicate success event');
        return;
      }

      alertShownRef.current = true;
      setSubmitting(false);

      // Ìèº Ï¥àÍ∏∞Ìôî
      setVulnType('');
      setEndpoint('');
      setParameter('');
      setPayload('');

      // ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®
      socket.emit('scannerRace:get-state');

      alert(`‚úÖ ${data.message}\n\nPoints awarded: +${data.pointsAwarded}${data.isFirstBlood ? '\nü©∏ FIRST BLOOD!' : ''}`);

      // ÏïåÎ¶º ÌëúÏãú ÌõÑ ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
      setTimeout(() => {
        alertShownRef.current = false;
      }, 500);
    };

    // Ï†úÏ∂ú Ïã§Ìå®
    const handleSubmissionFailed = (data: any) => {
      console.log('‚ùå [handleSubmissionFailed] Submission failed:', data);

      // Ïù¥ÎØ∏ ÏïåÎ¶º ÌëúÏãú Ï§ëÏù¥Î©¥ Î¨¥Ïãú
      if (alertShownRef.current) {
        console.warn('‚ö†Ô∏è Alert already shown, ignoring duplicate failed event');
        return;
      }

      alertShownRef.current = true;
      setSubmitting(false);

      alert(`‚ùå ${data.message}\n\nPoints: ${data.pointsAwarded}`);

      // ÏïåÎ¶º ÌëúÏãú ÌõÑ ÌîåÎûòÍ∑∏ Î¶¨ÏÖã
      setTimeout(() => {
        alertShownRef.current = false;
      }, 500);
    };

    socket.on('scannerRace:state-data', handleStateData);
    socket.on('scannerRace:scores-update', handleLeaderboardUpdate);
    socket.on('scannerRace:submission-success', handleSubmissionSuccess);
    socket.on('scannerRace:submission-failed', handleSubmissionFailed);

    console.log('‚úÖ [VulnerabilityScannerRace] Event listeners registered');

    return () => {
      console.log('üßπ [VulnerabilityScannerRace] Cleaning up event listeners');
      socket.off('scannerRace:state-data', handleStateData);
      socket.off('scannerRace:scores-update', handleLeaderboardUpdate);
      socket.off('scannerRace:submission-success', handleSubmissionSuccess);
      socket.off('scannerRace:submission-failed', handleSubmissionFailed);
    };
  }, [arenaId]);

  // iframe navigation Î∞©ÏßÄ
  useEffect(() => {
    const iframe = iframeRef.current;
    if (!iframe || !gameState?.vulnerableHTML) return;

    const handleIframeLoad = () => {
      if (!iframeLoadedRef.current) {
        // Ï≤´ Î°úÎìú
        console.log('‚úÖ [iframe] Initial load complete');
        iframeLoadedRef.current = true;
      } else {
        // Ïù¥ÌõÑ Î°úÎìú = navigation Î∞úÏÉù ‚Üí ÏõêÎûò HTMLÎ°ú Î≥µÏõê
        console.warn('‚ö†Ô∏è [iframe] Navigation detected, restoring original HTML');
        if (iframe.contentDocument) {
          iframe.contentDocument.open();
          iframe.contentDocument.write(gameState.vulnerableHTML);
          iframe.contentDocument.close();
        }
      }
    };

    iframe.addEventListener('load', handleIframeLoad);

    return () => {
      iframe.removeEventListener('load', handleIframeLoad);
      iframeLoadedRef.current = false; // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Î¶¨ÏÖã
    };
  }, [gameState?.vulnerableHTML]);

  // postMessage Ìï∏Îì§Îü¨ (ÏûêÎèô Ï∑®ÏïΩÏ†ê Í∞êÏßÄ)
  useEffect(() => {
    const handleIframeMessage = (event: MessageEvent) => {
      if (event.data.type === 'vulnerability_found') {
        const { vulnId, vulnType, endpoint, parameter, payload } = event.data;
        console.log('üéØ [postMessage] Auto-detected vulnerability:', vulnType, endpoint, parameter, payload);

        // ÏûêÎèô Ï†úÏ∂ú - submitting Ï≤¥ÌÅ¨ Ï†úÍ±∞ (refÎ°ú Í¥ÄÎ¶¨)
        setSubmitting(true);
        socket.emit('scannerRace:submit', {
          vulnType: vulnType,
          endpoint: endpoint || '/',
          parameter: parameter || '',
          payload: payload || ''
        });
        console.log('üì§ [postMessage] Auto-submitted vulnerability');
      }
    };

    window.addEventListener('message', handleIframeMessage);
    return () => window.removeEventListener('message', handleIframeMessage);
  }, []); // ÏùòÏ°¥ÏÑ± Î∞∞Ïó¥ Ï†úÍ±∞ - Ìïú Î≤àÎßå Îì±Î°ù

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (submitting) {
      console.warn('‚ö†Ô∏è [handleSubmit] Already submitting, ignoring...');
      return;
    }

    // ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
    if (!vulnType || !endpoint || !parameter || !payload) {
      alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    console.log('üì§ [handleSubmit] Manual submission:', { vulnType, endpoint, parameter, payload });
    setSubmitting(true);

    // ÌÉÄÏûÑÏïÑÏõÉ: 5Ï¥à ÌõÑÏóêÎèÑ ÏùëÎãµÏù¥ ÏóÜÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Î¶¨ÏÖã
    setTimeout(() => {
      setSubmitting(prev => {
        if (prev) {
          console.warn('‚è∞ [handleSubmit] Submission timeout, resetting submitting state');
          return false;
        }
        return prev;
      });
    }, 5000);

    socket.emit('scannerRace:submit', {
      vulnType,
      endpoint,
      parameter,
      payload
    });
  };

  if (loading) {
    return (
      <div className="vulnerability-scanner-race">
        <div className="scanner-loading">
          <div className="loading-container">
            <div className="loading-animation">
              <div className="terminal-line">
                <span className="prompt">root@scanner:~$</span>
                <span className="command">nmap -sV -A target.local</span>
              </div>
              <div className="terminal-line">
                <span className="prompt">root@scanner:~$</span>
                <span className="command">initializing scanner modules</span>
                <span className="cursor"></span>
              </div>
              <div className="terminal-line status">
                <span className="status-text">[*] Loading target environment...</span>
              </div>
              <div className="terminal-line status">
                <span className="status-text">[*] Establishing secure connection...</span>
              </div>
            </div>
            <div className="loading-spinner"></div>
          </div>
        </div>
      </div>
    );
  }

  if (!gameState) {
    return (
      <div className="vulnerability-scanner-race">
        <div className="scanner-error">Failed to load game state</div>
      </div>
    );
  }

  const myProgress = gameState.myProgress || { score: 0, foundVulnerabilities: [], rank: 0 };
  const isSimulated = gameState.mode === 'SIMULATED';

  return (
    <div className="vulnerability-scanner-race">
      {/* ÏÉÅÎã® Ìó§Îçî */}
      <div className="scanner-header">
        <div className="header-left">
          <div className="target-indicator">
            <span className="indicator-light"></span>
            <div className="target-info">
              <h2>{gameState.targetName || 'Loading...'}</h2>
              <span className={`mode-badge ${isSimulated ? 'simulated' : 'real'}`}>
                {isSimulated ? 'SIMULATED' : 'LIVE'}
              </span>
            </div>
          </div>
        </div>

        <div className="header-stats">
          <div className="stat-box">
            <span className="stat-label">SCORE</span>
            <span className="stat-value">{myProgress.score}</span>
          </div>
          <div className="stat-box">
            <span className="stat-label">VULNS</span>
            <span className="stat-value">{myProgress.foundVulnerabilities.length}/{gameState.vulnerabilities?.length || 0}</span>
          </div>
          <div className="stat-box rank">
            <span className="stat-label">RANK</span>
            <span className="stat-value">#{myProgress.rank}</span>
          </div>
        </div>
      </div>

      {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
      <div className="scanner-main">
        {/* ÏôºÏ™Ω: ÌÉÄÍ≤ü Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò */}
        <div className="target-container">
          <div className="target-header">
            <div className="header-title">
              <span className="icon">‚ñ∏</span>
              <h3>TARGET APPLICATION</h3>
            </div>
            <p className="target-desc">{gameState.targetDescription}</p>
          </div>

          {isSimulated ? (
            <iframe
              ref={iframeRef}
              srcDoc={gameState.vulnerableHTML}
              sandbox="allow-scripts allow-forms allow-modals"
              className="target-iframe"
              title="Vulnerable Application"
            />
          ) : (
            <div className="target-link">
              <div className="link-box">
                <div className="url-display">
                  <span className="label">TARGET URL:</span>
                  <code className="url">{gameState.targetUrl}</code>
                </div>
                <a
                  href={gameState.targetUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="launch-btn"
                >
                  OPEN TARGET ‚Üí
                </a>
              </div>
            </div>
          )}
        </div>

        {/* Ïò§Î•∏Ï™Ω: Ï†ïÎ≥¥ Ìå®ÎÑê */}
        <div className="info-panel">
          {/* Ï∑®ÏïΩÏ†ê Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ */}
          <div className="vulnerabilities-section">
            <div className="section-header">
              <span className="icon">‚óâ</span>
              <h3>TARGETS</h3>
              <span className="count">{myProgress.foundVulnerabilities.length}/{gameState.vulnerabilities?.length || 0}</span>
            </div>
            <div className="vuln-list">
              {(gameState.vulnerabilities || []).map((vuln) => {
                const isFound = myProgress.foundVulnerabilities.includes(vuln.vulnId);
                const isMine = vuln.discoveredBy === userId;

                return (
                  <div
                    key={vuln.vulnId}
                    className={`vuln-item ${isFound ? 'found' : ''} ${isMine ? 'mine' : ''}`}
                  >
                    <div className="vuln-status">
                      <span className="status-indicator">{isFound ? '‚óè' : '‚óã'}</span>
                    </div>
                    <div className="vuln-info">
                      <div className="vuln-name">{vuln.name}</div>
                      <div className="vuln-meta">
                        <span className={`severity severity-${vuln.severity.toLowerCase()}`}>
                          {vuln.severity}
                        </span>
                        <span className="type">{vuln.type}</span>
                        <span className="points">+{vuln.points}</span>
                      </div>
                      {vuln.isFirstBlood && vuln.discoveredByUsername && (
                        <div className="first-blood">
                          <span className="badge">FIRST BLOOD</span>
                          <span className="user">{vuln.discoveredByUsername}</span>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Ï†úÏ∂ú Ìèº */}
          <div className="submit-section">
            <div className="section-header">
              <span className="icon">‚ñ∏</span>
              <h3>REPORT FINDING</h3>
            </div>
            <form onSubmit={handleSubmit} className="submit-form">
              <div className="form-row">
                <div className="form-group">
                  <label>VULNERABILITY TYPE</label>
                  <select
                    value={vulnType}
                    onChange={e => setVulnType(e.target.value)}
                    required
                  >
                    <option value="">-- SELECT --</option>
                    <option value="SQLi">SQL Injection</option>
                    <option value="XSS">XSS</option>
                    <option value="CSRF">CSRF</option>
                    <option value="IDOR">IDOR</option>
                    <option value="Path Traversal">Path Traversal</option>
                    <option value="Command Injection">Command Injection</option>
                    <option value="Broken Authentication">Auth Bypass</option>
                    <option value="Security Misconfiguration">Misconfiguration</option>
                  </select>
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>ENDPOINT</label>
                  <input
                    type="text"
                    value={endpoint}
                    onChange={e => setEndpoint(e.target.value)}
                    placeholder="/api/login"
                    required
                  />
                </div>
              </div>

              <div className="form-row-split">
                <div className="form-group">
                  <label>PARAMETER</label>
                  <input
                    type="text"
                    value={parameter}
                    onChange={e => setParameter(e.target.value)}
                    placeholder="username"
                  />
                </div>
                <div className="form-group">
                  <label>PAYLOAD</label>
                  <input
                    type="text"
                    value={payload}
                    onChange={e => setPayload(e.target.value)}
                    placeholder="' OR 1=1--"
                  />
                </div>
              </div>

              <button type="submit" className="submit-btn" disabled={submitting}>
                {submitting ? 'PROCESSING...' : 'SUBMIT REPORT'}
              </button>
            </form>
          </div>

          {/* Î¶¨ÎçîÎ≥¥Îìú */}
          <div className="leaderboard-section">
            <div className="section-header">
              <span className="icon">‚ñ£</span>
              <h3>LEADERBOARD</h3>
            </div>
            <div className="leaderboard-list">
              {(gameState.leaderboard || []).slice(0, 5).map((player, index) => (
                <div
                  key={player.userId}
                  className={`leaderboard-item ${player.userId === userId ? 'current-user' : ''}`}
                >
                  <div className="rank rank-{index + 1}">
                    {index + 1}
                  </div>
                  <div className="player-info">
                    <div className="player-name">{player.username}</div>
                    <div className="player-stats">
                      <span className="vulns-found">{player.vulnerabilitiesFound} vulns</span>
                    </div>
                  </div>
                  <div className="player-score">{player.score}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityScannerRace;
