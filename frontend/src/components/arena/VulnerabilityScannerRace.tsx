import React, { useEffect, useState, useRef } from 'react';
import socket from '../../utils/socket';
import '../../assets/scss/arena/VulnerabilityScannerRace.scss';

interface Vulnerability {
  vulnId: string;
  name: string;
  type: string;
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  points: number;
  discoveredBy?: string;
  discoveredByUsername?: string;
  isFirstBlood?: boolean;
}

interface Player {
  userId: string;
  username: string;
  score: number;
  vulnerabilitiesFound: number;
}

interface GameState {
  targetUrl: string;
  targetName: string;
  targetDescription: string;
  mode: 'SIMULATED' | 'REAL';
  vulnerableHTML: string;
  vulnerabilities: Vulnerability[];
  leaderboard: Player[];
  myProgress: {
    score: number;
    foundVulnerabilities: string[];
    rank: number;
  };
}

interface VulnerabilityScannerRaceProps {
  arenaId: string;
  userId: string;
}

const VulnerabilityScannerRace: React.FC<VulnerabilityScannerRaceProps> = ({
  arenaId,
  userId
}) => {
  const iframeRef = useRef<HTMLIFrameElement>(null);

  const [loading, setLoading] = useState(true);
  const [gameState, setGameState] = useState<GameState | null>(null);

  // ì œì¶œ í¼ ìƒíƒœ
  const [vulnType, setVulnType] = useState('');
  const [endpoint, setEndpoint] = useState('');
  const [parameter, setParameter] = useState('');
  const [payload, setPayload] = useState('');
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => {
    // ê²Œì„ ìƒíƒœ ìš”ì²­
    socket.emit('scannerRace:get-state');

    // ê²Œì„ ìƒíƒœ ìˆ˜ì‹ 
    const handleStateData = (data: GameState) => {
      console.log('ğŸ“¥ Received game state:', data);
      setGameState(data);
      setLoading(false);
    };

    // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
    const handleLeaderboardUpdate = (data: { leaderboard: Player[] }) => {
      setGameState(prev => prev ? { ...prev, leaderboard: data.leaderboard } : null);
    };

    // ì œì¶œ ê²°ê³¼
    const handleSubmitResult = (data: { success: boolean; message: string; vulnerability?: Vulnerability }) => {
      setSubmitting(false);

      if (data.success && data.vulnerability) {
        // ì„±ê³µ ì‹œ í¼ ì´ˆê¸°í™”
        setVulnType('');
        setEndpoint('');
        setParameter('');
        setPayload('');

        // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        socket.emit('scannerRace:get-state');
      }

      alert(data.message);
    };

    socket.on('scannerRace:state-data', handleStateData);
    socket.on('scannerRace:leaderboard-update', handleLeaderboardUpdate);
    socket.on('scannerRace:submit-result', handleSubmitResult);

    return () => {
      socket.off('scannerRace:state-data', handleStateData);
      socket.off('scannerRace:leaderboard-update', handleLeaderboardUpdate);
      socket.off('scannerRace:submit-result', handleSubmitResult);
    };
  }, [arenaId]);

  // postMessage í•¸ë“¤ëŸ¬ (ìë™ ì·¨ì•½ì  ê°ì§€)
  useEffect(() => {
    const handleIframeMessage = (event: MessageEvent) => {
      if (event.data.type === 'vulnerability_found') {
        const { vulnId, vulnType, endpoint, parameter, payload } = event.data;
        console.log('ğŸ¯ Auto-detected vulnerability:', vulnType, endpoint);

        // ìë™ ì œì¶œ (state ì—…ë°ì´íŠ¸ ì—†ì´ ì§ì ‘ emit)
        if (!submitting) {
          setSubmitting(true);
          socket.emit('scannerRace:submit', {
            vulnType: vulnType,
            endpoint: endpoint || '/',
            parameter: parameter || '',
            payload: payload || ''
          });
        }
      }
    };

    window.addEventListener('message', handleIframeMessage);
    return () => window.removeEventListener('message', handleIframeMessage);
  }, [submitting]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (submitting) return;

    setSubmitting(true);
    socket.emit('scannerRace:submit', {
      vulnType,
      endpoint,
      parameter,
      payload
    });
  };

  if (loading) {
    return (
      <div className="vulnerability-scanner-race">
        <div className="scanner-loading">
          <div className="spinner"></div>
          <p>Loading game...</p>
        </div>
      </div>
    );
  }

  if (!gameState) {
    return (
      <div className="vulnerability-scanner-race">
        <div className="scanner-error">Failed to load game state</div>
      </div>
    );
  }

  const myProgress = gameState.myProgress || { score: 0, foundVulnerabilities: [], rank: 0 };
  const isSimulated = gameState.mode === 'SIMULATED';

  return (
    <div className="vulnerability-scanner-race">
      {/* ìƒë‹¨ í—¤ë” */}
      <div className="scanner-header">
        <div className="header-left">
          <h2>ğŸ¯ {gameState.targetName || 'Loading...'}</h2>
          <span className={`mode-badge ${isSimulated ? 'simulated' : 'real'}`}>
            {isSimulated ? 'ğŸ“ PRACTICE MODE' : 'âš”ï¸ LIVE TARGET'}
          </span>
        </div>

        <div className="header-stats">
          <div className="stat-box">
            <span className="stat-label">YOUR SCORE</span>
            <span className="stat-value">{myProgress.score}</span>
          </div>
          <div className="stat-box">
            <span className="stat-label">FOUND</span>
            <span className="stat-value">{myProgress.foundVulnerabilities.length}/{gameState.vulnerabilities?.length || 0}</span>
          </div>
          <div className="stat-box">
            <span className="stat-label">RANK</span>
            <span className="stat-value">#{myProgress.rank}</span>
          </div>
        </div>
      </div>

      {/* ë©”ì¸ ì½˜í…ì¸  */}
      <div className="scanner-main">
        {/* ì™¼ìª½: íƒ€ê²Ÿ ì• í”Œë¦¬ì¼€ì´ì…˜ */}
        <div className="target-container">
          <div className="target-header">
            <h3>TARGET APPLICATION</h3>
            <p>{gameState.targetDescription}</p>
          </div>

          {isSimulated ? (
            <iframe
              ref={iframeRef}
              srcDoc={gameState.vulnerableHTML}
              sandbox="allow-scripts allow-forms allow-modals allow-same-origin"
              className="target-iframe"
              title="Vulnerable Application"
            />
          ) : (
            <div className="target-link">
              <div className="link-box">
                <p className="link-url">{gameState.targetUrl}</p>
                <a
                  href={gameState.targetUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="launch-btn"
                >
                  ğŸš€ Open Target
                </a>
              </div>
            </div>
          )}
        </div>

        {/* ì˜¤ë¥¸ìª½: ì •ë³´ íŒ¨ë„ */}
        <div className="info-panel">
          {/* ì·¨ì•½ì  ì²´í¬ë¦¬ìŠ¤íŠ¸ */}
          <div className="vulnerabilities-section">
            <h3>ğŸ” VULNERABILITIES TO FIND</h3>
            <div className="vuln-list">
              {(gameState.vulnerabilities || []).map((vuln) => {
                const isFound = myProgress.foundVulnerabilities.includes(vuln.vulnId);
                const isMine = vuln.discoveredBy === userId;

                return (
                  <div
                    key={vuln.vulnId}
                    className={`vuln-item ${isFound ? 'found' : ''} ${isMine ? 'mine' : ''}`}
                  >
                    <div className="vuln-icon">
                      {isFound ? 'âœ…' : 'â¬œ'}
                    </div>
                    <div className="vuln-info">
                      <div className="vuln-name">{vuln.name}</div>
                      <div className="vuln-meta">
                        <span className={`severity ${vuln.severity.toLowerCase()}`}>
                          {vuln.severity}
                        </span>
                        <span className="points">{vuln.points}pts</span>
                      </div>
                      {vuln.isFirstBlood && vuln.discoveredByUsername && (
                        <div className="first-blood">
                          ğŸ©¸ First Blood: {vuln.discoveredByUsername}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* ì œì¶œ í¼ */}
          <div className="submit-section">
            <h3>ğŸ“ SUBMIT VULNERABILITY</h3>
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label>Type</label>
                <select
                  value={vulnType}
                  onChange={e => setVulnType(e.target.value)}
                  required
                >
                  <option value="">Select type...</option>
                  <option value="SQLi">SQL Injection</option>
                  <option value="XSS">Cross-Site Scripting</option>
                  <option value="CSRF">CSRF</option>
                  <option value="IDOR">IDOR</option>
                  <option value="Path Traversal">Path Traversal</option>
                  <option value="Command Injection">Command Injection</option>
                  <option value="Broken Authentication">Broken Authentication</option>
                  <option value="Security Misconfiguration">Security Misconfiguration</option>
                </select>
              </div>

              <div className="form-group">
                <label>Endpoint</label>
                <input
                  type="text"
                  value={endpoint}
                  onChange={e => setEndpoint(e.target.value)}
                  placeholder="/login, /search, etc."
                  required
                />
              </div>

              <div className="form-group">
                <label>Parameter (optional)</label>
                <input
                  type="text"
                  value={parameter}
                  onChange={e => setParameter(e.target.value)}
                  placeholder="username, id, etc."
                />
              </div>

              <div className="form-group">
                <label>Payload (optional)</label>
                <input
                  type="text"
                  value={payload}
                  onChange={e => setPayload(e.target.value)}
                  placeholder="' OR 1=1--, <script>alert(1)</script>, etc."
                />
              </div>

              <button type="submit" className="submit-btn" disabled={submitting}>
                {submitting ? 'SUBMITTING...' : 'ğŸš€ SUBMIT'}
              </button>
            </form>
          </div>

          {/* ë¦¬ë”ë³´ë“œ */}
          <div className="leaderboard-section">
            <h3>ğŸ† LEADERBOARD</h3>
            <div className="leaderboard-list">
              {(gameState.leaderboard || []).slice(0, 5).map((player, index) => (
                <div
                  key={player.userId}
                  className={`leaderboard-item ${player.userId === userId ? 'me' : ''}`}
                >
                  <div className="rank">#{index + 1}</div>
                  <div className="player-name">{player.username}</div>
                  <div className="player-score">{player.score}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityScannerRace;
