import React from 'react';
import { FaPlus, FaTrash, FaMinus } from 'react-icons/fa';

interface VulnerabilityData {
  type: string;
  description: string;
  solution: string;
  points: number;
}

interface ChainData {
  chain: number;
  vulnerabilities: VulnerabilityData[];
}

interface ExploitChainData {
  totalChains: number;
  chains: ChainData[];
}

interface Props {
  data: ExploitChainData;
  onChange: (data: ExploitChainData) => void;
}

const ExploitChainForm: React.FC<Props> = ({ data, onChange }) => {
  
  const addChain = () => {
    onChange({
      ...data,
      totalChains: data.chains.length + 1,
      chains: [
        ...data.chains,
        { chain: data.chains.length + 1, vulnerabilities: [] }
      ]
    });
  };

  const removeChain = (index: number) => {
    if (data.chains.length <= 1) return;
    onChange({
      ...data,
      totalChains: data.chains.length - 1,
      chains: data.chains.filter((_, i) => i !== index).map((c, i) => ({ ...c, chain: i + 1 }))
    });
  };

  const addVulnerability = (chainIndex: number) => {
    onChange({
      ...data,
      chains: data.chains.map((c, i) => 
        i === chainIndex ? {
          ...c,
          vulnerabilities: [
            ...c.vulnerabilities,
            { type: '', description: '', solution: '', points: 10 }
          ]
        } : c
      )
    });
  };

  const removeVulnerability = (chainIndex: number, vulnIndex: number) => {
    onChange({
      ...data,
      chains: data.chains.map((c, i) => 
        i === chainIndex ? {
          ...c,
          vulnerabilities: c.vulnerabilities.filter((_, vi) => vi !== vulnIndex)
        } : c
      )
    });
  };

  const updateVulnerability = (chainIndex: number, vulnIndex: number, field: string, value: any) => {
    onChange({
      ...data,
      chains: data.chains.map((c, i) => 
        i === chainIndex ? {
          ...c,
          vulnerabilities: c.vulnerabilities.map((v, vi) => 
            vi === vulnIndex ? { ...v, [field]: value } : v
          )
        } : c
      )
    });
  };

  return (
    <div>
      <h3 style={{ color: '#00d4ff', marginBottom: '15px' }}>Exploit Chain Challenge Settings</h3>

      <div style={{ marginBottom: '10px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
          <label style={{ fontSize: '11px', opacity: 0.7 }}>Chains ({data.chains.length})</label>
          <button type="button" onClick={addChain} style={{ padding: '4px 8px', fontSize: '11px' }}>
            <FaPlus /> Add Chain
          </button>
        </div>

        {data.chains.map((chain, cIdx) => (
          <div key={cIdx} style={{ 
            background: '#0f1624', 
            padding: '15px', 
            borderRadius: '6px', 
            marginBottom: '15px',
            border: '1px solid #2d2d44'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
              <strong style={{ color: '#00d4ff' }}>Chain {cIdx + 1}</strong>
              {data.chains.length > 1 && (
                <button 
                  type="button" 
                  onClick={() => removeChain(cIdx)}
                  style={{ padding: '4px 8px', fontSize: '12px' }}
                >
                  <FaMinus /> Remove
                </button>
              )}
            </div>

            {/* Vulnerabilities */}
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                <label style={{ fontSize: '11px', opacity: 0.7 }}>
                  Vulnerabilities ({chain.vulnerabilities.length})
                </label>
                <button 
                  type="button" 
                  onClick={() => addVulnerability(cIdx)}
                  style={{ padding: '4px 8px', fontSize: '11px' }}
                >
                  <FaPlus /> Add Vulnerability
                </button>
              </div>

              {chain.vulnerabilities.map((vuln, vIdx) => (
                <div key={vIdx} style={{ 
                  background: '#16213e', 
                  padding: '10px', 
                  borderRadius: '4px', 
                  marginBottom: '8px',
                  border: '1px solid #2d2d44'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                    <span style={{ fontSize: '11px', color: '#999' }}>Vulnerability {vIdx + 1}</span>
                    <button 
                      type="button" 
                      onClick={() => removeVulnerability(cIdx, vIdx)}
                      style={{ padding: '2px 6px', fontSize: '10px' }}
                    >
                      <FaTrash />
                    </button>
                  </div>

                  <div style={{ display: 'grid', gap: '8px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                      <input
                        type="text"
                        placeholder="Type (e.g., XSS, SQLi)"
                        value={vuln.type}
                        onChange={e => updateVulnerability(cIdx, vIdx, 'type', e.target.value)}
                        required
                      />
                      
                      <input
                        type="number"
                        placeholder="Points"
                        min={1}
                        value={vuln.points}
                        onChange={e => updateVulnerability(cIdx, vIdx, 'points', Number(e.target.value))}
                      />
                    </div>

                    <input
                      type="text"
                      placeholder="Description"
                      value={vuln.description}
                      onChange={e => updateVulnerability(cIdx, vIdx, 'description', e.target.value)}
                      required
                    />

                    <input
                      type="text"
                      placeholder="Solution (hash or flag)"
                      value={vuln.solution}
                      onChange={e => updateVulnerability(cIdx, vIdx, 'solution', e.target.value)}
                      required
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default ExploitChainForm;