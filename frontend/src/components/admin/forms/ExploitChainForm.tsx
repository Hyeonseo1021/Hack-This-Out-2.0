import React from 'react';
import { FaPlus, FaTrash, FaMinus } from 'react-icons/fa';
import '../../../assets/scss/admin/ExploitChainForm.scss';

interface VulnerabilityData {
  type: string;
  description: string;
  solution: string;
  points: number;
}

interface ChainData {
  chain: number;
  vulnerabilities: VulnerabilityData[];
}

interface ExploitChainData {
  totalChains: number;
  chains: ChainData[];
}

interface Props {
  data: ExploitChainData;
  onChange: (data: ExploitChainData) => void;
}

const ExploitChainForm: React.FC<Props> = ({ data, onChange }) => {
  
  const addChain = () => {
    onChange({
      ...data,
      totalChains: data.chains.length + 1,
      chains: [
        ...data.chains,
        { chain: data.chains.length + 1, vulnerabilities: [] }
      ]
    });
  };

  const removeChain = (index: number) => {
    if (data.chains.length <= 1) return;
    onChange({
      ...data,
      totalChains: data.chains.length - 1,
      chains: data.chains.filter((_, i) => i !== index).map((c, i) => ({ ...c, chain: i + 1 }))
    });
  };

  const addVulnerability = (chainIndex: number) => {
    onChange({
      ...data,
      chains: data.chains.map((c, i) => 
        i === chainIndex ? {
          ...c,
          vulnerabilities: [
            ...c.vulnerabilities,
            { type: '', description: '', solution: '', points: 10 }
          ]
        } : c
      )
    });
  };

  const removeVulnerability = (chainIndex: number, vulnIndex: number) => {
    onChange({
      ...data,
      chains: data.chains.map((c, i) => 
        i === chainIndex ? {
          ...c,
          vulnerabilities: c.vulnerabilities.filter((_, vi) => vi !== vulnIndex)
        } : c
      )
    });
  };

  const updateVulnerability = (chainIndex: number, vulnIndex: number, field: string, value: any) => {
    onChange({
      ...data,
      chains: data.chains.map((c, i) => 
        i === chainIndex ? {
          ...c,
          vulnerabilities: c.vulnerabilities.map((v, vi) => 
            vi === vulnIndex ? { ...v, [field]: value } : v
          )
        } : c
      )
    });
  };

  return (
    <div className="exploit-chain-form">
      <h3>Exploit Chain Challenge Settings</h3>

      <div>
        <div className="section-header">
          <label>Chains ({data.chains.length})</label>
          <button type="button" onClick={addChain}>
            <FaPlus /> Add Chain
          </button>
        </div>

        {data.chains.map((chain, cIdx) => (
          <div key={cIdx} className="chain-card">
            <div className="chain-header">
              <strong>Chain {cIdx + 1}</strong>
              {data.chains.length > 1 && (
                <button type="button" onClick={() => removeChain(cIdx)}>
                  <FaMinus /> Remove
                </button>
              )}
            </div>

            {/* Vulnerabilities */}
            <div className="vulnerabilities-section">
              <div className="section-header">
                <label>Vulnerabilities ({chain.vulnerabilities.length})</label>
                <button type="button" onClick={() => addVulnerability(cIdx)}>
                  <FaPlus /> Add Vulnerability
                </button>
              </div>

              {chain.vulnerabilities.map((vuln, vIdx) => (
                <div key={vIdx} className="vulnerability-card">
                  <div className="vulnerability-header">
                    <span>Vulnerability {vIdx + 1}</span>
                    <button type="button" onClick={() => removeVulnerability(cIdx, vIdx)}>
                      <FaTrash />
                    </button>
                  </div>

                  <div className="vulnerability-inputs">
                    <div className="input-row-2">
                      <input
                        type="text"
                        placeholder="Type (e.g., XSS, SQLi)"
                        value={vuln.type}
                        onChange={e => updateVulnerability(cIdx, vIdx, 'type', e.target.value)}
                        required
                      />
                      
                      <input
                        type="number"
                        placeholder="Points"
                        min={1}
                        value={vuln.points}
                        onChange={e => updateVulnerability(cIdx, vIdx, 'points', Number(e.target.value))}
                      />
                    </div>

                    <input
                      type="text"
                      placeholder="Description"
                      value={vuln.description}
                      onChange={e => updateVulnerability(cIdx, vIdx, 'description', e.target.value)}
                      required
                    />

                    <input
                      type="text"
                      placeholder="Solution (hash or flag)"
                      value={vuln.solution}
                      onChange={e => updateVulnerability(cIdx, vIdx, 'solution', e.target.value)}
                      required
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default ExploitChainForm;