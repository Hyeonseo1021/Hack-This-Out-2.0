import React from 'react';
import { FaPlus, FaTrash, FaMinus } from 'react-icons/fa';
import '../../../assets/scss/admin/forms/ExploitChainForm.scss';

interface ExploitStep {
  stage: string;
  question: string;
  options: string[];
  correct: string;
  explanation: string;
  points: number;
}

interface ExploitChainData {
  missionBrief: {
    target: string;
    goal: string;
    constraint: string;
  };
  steps: ExploitStep[];
  hintsAvailable: number;
  hintPenalty: number;
}

interface Props {
  data: ExploitChainData;
  onChange: (data: ExploitChainData) => void;
}

const ExploitChainForm: React.FC<Props> = ({ data, onChange }) => {
  
  const updateMissionBrief = (field: string, value: string) => {
    onChange({
      ...data,
      missionBrief: {
        ...data.missionBrief,
        [field]: value
      }
    });
  };

  const addStep = () => {
    onChange({
      ...data,
      steps: [
        ...data.steps,
        { 
          stage: '', 
          question: '', 
          options: ['', '', '', ''],
          correct: '',
          explanation: '', 
          points: 20 
        }
      ]
    });
  };

  const removeStep = (index: number) => {
    if (data.steps.length <= 1) return;
    onChange({
      ...data,
      steps: data.steps.filter((_, i) => i !== index)
    });
  };

  const updateStep = (index: number, field: string, value: any) => {
    onChange({
      ...data,
      steps: data.steps.map((s, i) => 
        i === index ? { ...s, [field]: value } : s
      )
    });
  };

  const updateOption = (stepIndex: number, optionIndex: number, value: string) => {
    onChange({
      ...data,
      steps: data.steps.map((s, i) => 
        i === stepIndex ? {
          ...s,
          options: s.options.map((opt, oi) => oi === optionIndex ? value : opt)
        } : s
      )
    });
  };

  return (
    <div className="exploit-chain-form">
      <h3>🎯 Exploit Chain Challenge 시나리오</h3>

      {/* 미션 브리핑 */}
      <div className="form-section">
        <h4>📋 미션 브리핑</h4>
        <div className="mission-brief">
          <div className="form-field">
            <label>타겟 시스템 *</label>
            <input
              type="text"
              placeholder="예: bank-server.com"
              value={data.missionBrief.target}
              onChange={e => updateMissionBrief('target', e.target.value)}
              required
            />
            <small>해킹할 대상 시스템</small>
          </div>

          <div className="form-field">
            <label>미션 목표 *</label>
            <input
              type="text"
              placeholder="예: 고객 데이터베이스 추출"
              value={data.missionBrief.goal}
              onChange={e => updateMissionBrief('goal', e.target.value)}
              required
            />
            <small>달성해야 할 목표</small>
          </div>

          <div className="form-field">
            <label>제약사항 *</label>
            <input
              type="text"
              placeholder="예: IDS 알림을 발생시키지 말 것"
              value={data.missionBrief.constraint}
              onChange={e => updateMissionBrief('constraint', e.target.value)}
              required
            />
            <small>미션 수행 시 주의사항</small>
          </div>
        </div>
      </div>

      {/* 힌트 설정 */}
      <div className="form-section">
        <h4>💡 힌트 시스템</h4>
        <div className="form-grid-2">
          <div className="form-field">
            <label>사용 가능한 힌트 수 *</label>
            <input
              type="number"
              min={0}
              max={10}
              value={data.hintsAvailable}
              onChange={e => onChange({ ...data, hintsAvailable: Number(e.target.value) })}
              required
            />
            <small>플레이어가 사용할 수 있는 힌트 횟수</small>
          </div>

          <div className="form-field">
            <label>힌트 사용 시 감점 *</label>
            <input
              type="number"
              min={0}
              max={50}
              value={data.hintPenalty}
              onChange={e => onChange({ ...data, hintPenalty: Number(e.target.value) })}
              required
            />
            <small>힌트 1회 사용 당 감점</small>
          </div>
        </div>
      </div>

      {/* 단계별 문제 */}
      <div className="form-section">
        <div className="section-header">
          <h4>🔗 해킹 단계 ({data.steps.length})</h4>
          <button type="button" onClick={addStep} className="btn-add">
            <FaPlus /> 단계 추가
          </button>
        </div>

        {data.steps.map((step, sIdx) => (
          <div key={sIdx} className="step-card">
            <div className="step-header">
              <strong>Step {sIdx + 1}: {step.stage || '(단계명 없음)'}</strong>
              {data.steps.length > 1 && (
                <button type="button" onClick={() => removeStep(sIdx)} className="btn-remove">
                  <FaMinus /> 삭제
                </button>
              )}
            </div>

            <div className="step-content">
              {/* Stage Name */}
              <div className="form-field">
                <label>단계 이름 *</label>
                <input
                  type="text"
                  placeholder="예: reconnaissance, initial_access, privilege_escalation"
                  value={step.stage}
                  onChange={e => updateStep(sIdx, 'stage', e.target.value)}
                  required
                />
                <small>영문 소문자와 언더스코어(_)만 사용</small>
              </div>

              {/* Question */}
              <div className="form-field">
                <label>질문 *</label>
                <textarea
                  rows={3}
                  placeholder="예: 타겟 시스템의 취약점을 찾기 위해 가장 먼저 해야 할 것은?"
                  value={step.question}
                  onChange={e => updateStep(sIdx, 'question', e.target.value)}
                  required
                />
              </div>

              {/* Options */}
              <div className="options-section">
                <label>선택지 (4개) *</label>
                {step.options.map((option, oIdx) => (
                  <div key={oIdx} className="option-input">
                    <span className="option-label">{String.fromCharCode(65 + oIdx)}.</span>
                    <input
                      type="text"
                      placeholder={`선택지 ${oIdx + 1}`}
                      value={option}
                      onChange={e => updateOption(sIdx, oIdx, e.target.value)}
                      required
                    />
                  </div>
                ))}
              </div>

              {/* Correct Answer */}
              <div className="form-field">
                <label>정답 *</label>
                <input
                  type="text"
                  placeholder="정답 선택지를 그대로 입력 (예: nmap -sV)"
                  value={step.correct}
                  onChange={e => updateStep(sIdx, 'correct', e.target.value)}
                  required
                />
                <small>위 선택지 중 정답에 해당하는 텍스트를 정확히 입력</small>
              </div>

              {/* Explanation */}
              <div className="form-field">
                <label>해설 *</label>
                <textarea
                  rows={4}
                  placeholder="예: nmap -sV는 서비스 버전 탐지를 수행합니다. 이를 통해 열린 포트, 실행 중인 서비스, 서비스 버전 정보를 획득할 수 있습니다."
                  value={step.explanation}
                  onChange={e => updateStep(sIdx, 'explanation', e.target.value)}
                  required
                />
                <small>정답에 대한 자세한 설명 (교육 목적)</small>
              </div>

              {/* Points */}
              <div className="form-field">
                <label>획득 점수 *</label>
                <input
                  type="number"
                  min={1}
                  max={100}
                  value={step.points}
                  onChange={e => updateStep(sIdx, 'points', Number(e.target.value))}
                  required
                />
                <small>정답 시 획득하는 점수</small>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* 점수 총합 표시 */}
      <div className="score-summary">
        <strong>총 만점: {data.steps.reduce((sum, s) => sum + s.points, 0)} 점</strong>
        <span>(힌트 미사용 시)</span>
      </div>
    </div>
  );
};

export default ExploitChainForm;